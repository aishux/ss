WITH MergedEmails AS (
    SELECT 
        LEVEL4_CODE, 
        LEVEL5_CODE, 
        VU1_EMAILS, 
        VW3_EMAILS, 
        email
    FROM your_table 
    LATERAL VIEW EXPLODE(SPLIT(VU1_EMAILS, ', ')) vu1 AS email
    WHERE LEVEL4_CODE = 'P9WP'

    UNION 

    SELECT 
        LEVEL4_CODE, 
        LEVEL5_CODE, 
        VU1_EMAILS, 
        VW3_EMAILS, 
        email
    FROM your_table 
    LATERAL VIEW EXPLODE(SPLIT(VW3_EMAILS, ', ')) vw3 AS email
    WHERE LEVEL4_CODE = 'P9WP'
)

SELECT 
    t.*, 
    ARRAY_JOIN(COLLECT_SET(m.email), ', ') AS VW3_EMAILS
FROM your_table t
LEFT JOIN MergedEmails m
ON t.LEVEL4_CODE = m.LEVEL4_CODE AND t.LEVEL5_CODE = m.LEVEL5_CODE
WHERE t.LEVEL4_CODE = 'P9WP'
GROUP BY t.*;
